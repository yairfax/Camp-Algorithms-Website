<title>Rosh Sports Portal: {{session.name}}</title>
<div class="top-right">
	<button class="btn btn-primary">Produce Chug List</button>
	<a href="/chugim?session={{sessionID}}" class="btn btn-primary" role="button">Back to Entering</a>
	<a href="/chugim/klugie" class="btn btn-primary" role="button">Select Another Session</a>
	<button data-toggle="modal" data-target="#editWarning" class="btn btn-info">Edit Session</button>
	<button data-toggle="modal" data-target="#deleteWarning" class="btn btn-danger">Delete Session</button>
</div>

<h1>{{session.name}}</h1>
<p>Camper Preferences
	<span style="float:right;">{{length prefs}} Campers Entered</span>
</p>
{{#if areCampers}}
<table class="table">
	<thead>
		<tr>
			<th>Name</th>
			<th>Eidah</th>
			<th>Bunk</th>
			<th>Choice 1</th>
			<th>Choice 2</th>
			<th>Choice 3</th>
		</tr>
	</thead>
	{{#each prefs}}
	<tr class="trow" data-toggle="modal" data-target="#camperModal">
		<td>{{@key}}</td>
		<td>{{titleCase this.eidah}}</td>
		<td>{{titleCase this.bunk}}</td>
		{{#each this.prefs}}
		<td>{{titleCase this}}</td>
		{{/each}}
	</tr>
	{{/each}}
</table>
{{else}}
<h3 style="text-align: center">Nothing to See Here!</h3>
{{/if}}

<!-- Camper Modal -->
<div class="modal fade" id="camperModal" >
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalTitle">Camper Data</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="/chugim/klugie?session={{session.id}}">
				<div class="modal-body">
					<div class="form-row">
						<div class="form-group col-md-5">
							<label for="name">Name</label>
							<input type="text" class="form-control" id="name" name="name" readonly>
						</div>
						<div class="form-group col-md-3">
							<label for="eidah">Eidah</label>
							<select class="custom-select" required id="eidah" name="eidah">
								{{#each eidot}}
								<option value="{{toLowerCase this}}">{{this}}</option>
								{{/each}}
							</select>
						</div>
						<div class="form-group col-md-4">
							<label for="bunk">Bunk</label>
							<select class="custom-select" required id="bunk" name="bunk"></select>
						</div>
					</div>
					{{#each counter}}
					<div class="form-group">
						<label for="pref{{this}}">Choice {{this}}</label>
						<select class="custom-select" required id="pref{{this}}" name="pref{{this}}"></select>
					</div>
					{{/each}}
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-danger" id="delete">Delete Camper</button>
					<button type="submit" class="btn btn-primary">Save changes</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Delete Warning -->
<div class="modal fade" id="deleteWarning" style="text-align: center">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalTitle">Are you sure?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p style="text-align: justify">Are you sure you want to delete this session? All of the camper data will be permentantly deleted. This action is not undoable.</p>
				<button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-danger" id="delete-session">Yes, Delete Session</button>
			</div>
		</div>
	</div>
</div>

<!-- Edit Warning -->
<div class="modal fade" id="editWarning" style="text-align: center">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalTitle">Are you sure?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p style="text-align: justify">Are you sure you want to edit the session? If you edit existing chug names and campers have already entered their preferences, the program later <b><i>will</i></b> fail.</p>
				<button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
				<a href="/chugim/klugie/newsession?session={{session.id}}" class="btn btn-warning" role="button">Yes, Edit Session</a>
			</div>
		</div>
	</div>
</div>

<script>
	var curEidah = ""

	//Crap to convert context into local JSON
	var ctxt = "{{stringify this}}";
	ctxt = ctxt.replace(/&quot;/gi, '\"')
	ctxt = JSON.parse(ctxt)

	//Make sure to pass in lower case eidah
	function bunksAndChugim(eidah) {
		$("#bunk").empty();
		$("#bunk").append(`<option value="" selected disabled>Select Bunk</option>`)
		for (var bunk of ctxt.session.bunks[eidah]) {
			$("#bunk").append(`<option value=${bunk.toLowerCase()}>${bunk}</option>`)
		}

		//Populate Chug List
		for (var i = 1; i <= 3; i++) {
				$(`#pref${i}`).empty()
				$(`#pref${i}`).append(`<option value="" disabled selected>Select Preference ${i}</option`)
		}
		for (var chug of ctxt.chugim[eidah]) {
			for (var i = 1; i <= 3; i++) {
				$(`#pref${i}`).append(`<option value="${chug.toLowerCase()}">${chug}</option>`)
			}
		}
	}

	// Set coloring for tables
	$(".trow").on({
		'mouseenter': function() {
			$(this).css("background-color", "#b3caef")},
		'mouseleave': function() {
			$(this).css("background-color", "white")},
	});


	// Use modal presentation event
	$("#camperModal").on("show.bs.modal", function(event) {
		var row = $(event.relatedTarget)
		data = row.find('td')
		modal = $(this)
		curEidah = data[1].textContent.toLowerCase()
		
		modal.find('#name').val(data[0].textContent)
		modal.find('#eidah').val(data[1].textContent.toLowerCase())
		bunksAndChugim(curEidah)
		modal.find('#bunk').val(data[2].textContent.toLowerCase())
		for (var i = 1; i <= 3; i++) {
			modal.find(`#pref${i}`).val(data[i+2].textContent.toLowerCase())
		}
	});

	$("#eidah").on("change", function() {
		bunksAndChugim($(this)[0].value)
	});

	$("#delete").on('click', function() {
		$.ajax({
			url: `/chugim/klugie?session=${ctxt.sessionID}&camper=${$("#name").val().replace(/ /, '+')}`,
			type: 'DELETE',
			success: function(result) {
				if (result === "Success") {window.location.replace(`/chugim/klugie?session=${ctxt.sessionID}`);}
			}
		})
	});

	$("#delete-session").on('click', function() {
		$.ajax({
			url: `/chugim/klugie/newsession?session=${ctxt.sessionID}`,
			type: 'DELETE',
			success: function(result) {
				if (result === "Success") {window.location.replace(`/chugim/klugie`);}
			}
		})
	})
</script>